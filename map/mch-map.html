<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SwissTopo Map</title>
    <link
      href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <style>
      body {
        margin: 0;
      }

      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }

      .maplibregl-popup {
        padding: 5px;
        transition: background-color 0.3s;
      }

      #coordinates {
        position: absolute;
        bottom: 40px;
        right: 20px;
        background: rgba(255, 255, 255, 0.8);
        padding: 5px 10px;
        border-radius: 4px;
        font-family: monospace;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      #coordinates:active {
        background: rgba(200, 200, 200, 0.8);
      }

      #zoomlevel {
        position: absolute;
        top: 10px;
        right: 20px;
        background: rgba(255, 255, 255, 0.8);
        padding: 5px 10px;
        border-radius: 4px;
        font-family: monospace;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>
    <div id="coordinates"></div>
    <div id="zoomlevel"></div>
    <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
    <script>
      const map = new maplibregl.Map({
        container: "map",
        style: "mch-style.json",
        center: [8.2, 46.8],
        zoom: 7,
        maxZoom: 12,
        minZoom: 0,
        bounds: [5.9559, 45.818, 10.4921, 47.8084],
      });

      // Add back mousemove handler
      map.on('mousemove', (e) => {
        document.getElementById('coordinates').innerHTML =
          `Lon: ${e.lngLat.lng.toFixed(6)} Lat: ${e.lngLat.lat.toFixed(6)}`;
      });

      // Add click handler for coordinates div
      document.getElementById('coordinates').addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(document.getElementById('coordinates').textContent);
          document.getElementById('coordinates').style.background = 'rgba(150, 255, 150, 0.8)';
          setTimeout(() => {
            document.getElementById('coordinates').style.background = 'rgba(255, 255, 255, 0.8)';
          }, 200);
        } catch (err) {
          console.error('Failed to copy coordinates:', err);
        }
      });

      // Create a popup but don't add it to the map yet
      const popup = new maplibregl.Popup({
        closeButton: false,
        closeOnClick: false
      });

      map.on('click', async (e) => {
        const coordinates = `${e.lngLat.lng.toFixed(6)}, ${e.lngLat.lat.toFixed(6)}`;

        try {
          await navigator.clipboard.writeText(coordinates);

          // Show popup at click location
          popup
            .setLngLat(e.lngLat)
            .setHTML(`<h4>Coordinates copied!</h4>Lon: ${e.lngLat.lng}<br>Lat: ${e.lngLat.lat}`)
            .addTo(map);

          // Remove popup after 1 second
          setTimeout(() => {
            popup.remove();
          }, 2000);
        } catch (err) {
          console.error('Failed to copy coordinates:', err);
        }
      });

      // Add zoom level display update
      map.on('move', () => {
        document.getElementById('zoomlevel').innerHTML =
          `Zoom: ${map.getZoom().toFixed(2)}`;
      });

      map.on("load", () => {
        map.addSource("hillshade", {
          type: "raster",
          tiles: [
            "https://api.maptiler.com/tiles/hillshade/{z}/{x}/{y}.webp?key=k0SiRr6RGDFRdeBbNb3v",
          ],
          tileSize: 512,
          attribution:
            '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a>',
        });

        map.addLayer({
          id: "hillshade-layer",
          type: "raster",
          source: "hillshade",
          paint: {
            "raster-opacity": 0.3,
          },
        });

        // add swissboundaries source
        // from mch website export
        map.addSource("swiss-boundary", {
          type: "geojson",
          data: "swiss_boundary.json",
        });

        // Add swiss-boundary fill layer
        map.addLayer({
          id: "swiss-boundary-fill",
          type: "fill",
          source: "swiss-boundary",
          paint: {
            "fill-color": "transparent",
            "fill-opacity": 0.1,
          },
        });

        // Add swiss-boundary outline layer
        map.addLayer({
          id: "swiss-boundary-line",
          type: "line",
          source: "swiss-boundary",
          paint: {
            "line-color": "#000",
            "line-width": 2,
            "line-opacity": 0.5,
          },
        });

        // Add canton boundaries source
        // https://data.opendatasoft.com/explore/dataset/georef-switzerland-kanton%40public/export/?disjunctive.kan_code&disjunctive.kan_name&sort=year&location=10,46.89962,7.36702&basemap=jawg.streets&dataChart=eyJxdWVyaWVzIjpbeyJjb25maWciOnsiZGF0YXNldCI6Imdlb3JlZi1zd2l0emVybGFuZC1rYW50b25AcHVibGljIiwib3B0aW9ucyI6eyJkaXNqdW5jdGl2ZS5rYW5fY29kZSI6dHJ1ZSwiZGlzanVuY3RpdmUua2FuX25hbWUiOnRydWUsInNvcnQiOiJ5ZWFyIn19LCJjaGFydHMiOlt7ImFsaWduTW9udGgiOnRydWUsInR5cGUiOiJsaW5lIiwiZnVuYyI6IkNPVU5UIiwic2NpZW50aWZpY0Rpc3BsYXkiOnRydWUsImNvbG9yIjoiIzE0MkU3QiJ9XSwieEF4aXMiOiJ5ZWFyIiwibWF4cG9pbnRzIjoiIiwidGltZXNjYWxlIjoieWVhciIsInNvcnQiOiIifV0sImRpc3BsYXlMZWdlbmQiOnRydWUsImFsaWduTW9udGgiOnRydWV9
        map.addSource("canton-boundaries", {
          type: "geojson",
          data: "swiss_cantons.geojson",
        });

        // Add canton boundaries layer
        map.addLayer({
          id: "canton-boundaries-layer",
          type: "line",
          source: "canton-boundaries",
          paint: {
            "line-color": "#808080",
            "line-width": 1,
            "line-opacity": 0.7,
          },
        });

        // Add cities source
        map.addSource("cities", {
          type: "geojson",
          data: "cities.json",
        });

        map.addLayer({
          id: "cities-layer",
          type: "circle",
          source: "cities",
          paint: {
            "circle-radius": 1.5,
            "circle-color": "#ffffff",
            "circle-stroke-width": 2,
            "circle-stroke-color": "#000000"
          },
          filter: [">=", ["+", 1.25, ["zoom"]], ["get", "minzoom"]],
        });

        map.addLayer({
          id: "cities-labels",
          type: "symbol",
          source: "cities",
          layout: {
            "text-field": ["get", "place"],
            "text-font": ["Open Sans Regular", "Arial Unicode MS Regular"],
            "text-justify": "left",
            "text-offset": [0.5, 0.2],
            "text-anchor": "bottom-left",
            "text-size": 12,
          },
          paint: {
            "text-color": "#000000",
            "text-halo-color": "#ffffff",
            "text-halo-width": 2
          },
          filter: [">=", ["+", 1.25, ["zoom"]], ["get", "minzoom"]],
        });
      });
    </script>
  </body>
</html>
